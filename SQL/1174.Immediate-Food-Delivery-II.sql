-- 1174.Immediate-Food-Delivery-II.sql

-- Step 1: Create the temporary table
CREATE TABLE #Delivery (
    delivery_id INT,
    customer_id INT,
    order_date DATE,
    customer_pref_delivery_date DATE
);

-- Step 2: Insert the provided data into the temporary table
INSERT INTO #Delivery (delivery_id, customer_id, order_date, customer_pref_delivery_date) VALUES (289, 7, '2019-07-22', '2019-08-13'), (85, 90, '2019-08-01', '2019-08-18'), (982, 82, '2019-08-15', '2019-08-16'), (325, 61, '2019-08-30', '2019-08-30'), (652, 18, '2019-08-05', '2019-08-15'), (176, 64, '2019-07-02', '2019-07-02'), (248, 86, '2019-07-19', '2019-08-04'), (720, 7, '2019-07-08', '2019-08-20'), (557, 41, '2019-07-25', '2019-07-25'), (426, 47, '2019-07-15', '2019-08-03'), (1000, 20, '2019-07-17', '2019-07-17'), (947, 71, '2019-07-14', '2019-08-18'), (379, 27, '2019-07-09', '2019-08-14'), (886, 42, '2019-08-10', '2019-08-18'), (943, 94, '2019-08-06', '2019-08-08'), (87, 85, '2019-07-19', '2019-07-29'), (179, 98, '2019-07-31', '2019-07-31'), (733, 53, '2019-08-22', '2019-08-24'), (224, 81, '2019-08-31', '2019-08-31'), (394, 78, '2019-07-29', '2019-07-29'), (451, 47, '2019-07-01', '2019-08-24'), (149, 1, '2019-08-29', '2019-08-29'), (328, 41, '2019-07-10', '2019-07-10'), (169, 100, '2019-08-31', '2019-08-31'), (977, 92, '2019-08-17', '2019-08-31'), (492, 63, '2019-08-23', '2019-08-23'), (686, 88, '2019-08-25', '2019-08-26'), (800, 47, '2019-07-16', '2019-07-16'), (638, 91, '2019-08-19', '2019-08-24'), (405, 74, '2019-08-29', '2019-08-30'), (861, 10, '2019-08-08', '2019-08-24'), (984, 19, '2019-07-17', '2019-07-30'), (702, 5, '2019-07-21', '2019-08-20'), (228, 100, '2019-07-27', '2019-08-24'), (461, 85, '2019-08-13', '2019-08-13'), (602, 81, '2019-08-29', '2019-08-29'), (135, 98, '2019-08-23', '2019-08-23'), (489, 85, '2019-08-14', '2019-08-20'), (350, 3, '2019-08-05', '2019-08-05'), (99, 42, '2019-07-02', '2019-08-06'), (449, 9, '2019-08-07', '2019-08-11'), (397, 83, '2019-08-12', '2019-08-21'), (109, 71, '2019-08-29', '2019-08-30'), (526, 6, '2019-08-02', '2019-08-02'), (695, 71, '2019-07-24', '2019-07-25'), (574, 68, '2019-08-15', '2019-08-18'), (268, 88, '2019-07-06', '2019-07-06'), (190, 46, '2019-07-18', '2019-08-19'), (163, 27, '2019-07-28', '2019-07-28'), (476, 70, '2019-07-21', '2019-07-21'), (104, 72, '2019-08-30', '2019-08-30'), (881, 58, '2019-07-18', '2019-07-18'), (47, 49, '2019-07-23', '2019-07-26'), (303, 82, '2019-08-08', '2019-08-09'), (500, 74, '2019-08-27', '2019-08-28'), (65, 15, '2019-07-28', '2019-08-20'), (160, 82, '2019-07-01', '2019-08-28');


-- Step 3: Select the data from the temporary table
WITH cteTable AS
(
   	SELECT customer_id,order_date,customer_pref_delivery_date,
	ROW_NUMBER() OVER (PARTITION BY customer_id ORDER BY order_date) AS rn
	FROM #Delivery
)
SELECT 
sum(case when order_date = customer_pref_delivery_date then 1 else 0 end) immediate_data,count(1) total_data,
cast(((sum(case when order_date = customer_pref_delivery_date then 1 else 0 end)*1.00) / count(1)*100) as decimal(5,2)) immediate_percentage
FROM cteTable
WHERE rn = 1



-- Step 4: Drop the temporary table
DROP TABLE #Delivery;
